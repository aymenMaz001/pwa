<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PWA Camera & QR Scanner</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="QR Cam">
    <meta name="description" content="Scanner QR codes et appareil photo en PWA">
    
    <!-- Manifest -->
    <link rel="manifest" href="./manifest.json">
    
    <!-- Favicons -->
    <link rel="icon" href="./icons/favicon.ico">
    <link rel="apple-touch-icon" href="./icons/icon-192.png">
    
    <!-- QR Code Scanner Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qr-scanner/1.4.2/qr-scanner.umd.min.js"></script>
    
    <!-- Open Graph -->
    <meta property="og:title" content="PWA Camera & QR Scanner">
    <meta property="og:description" content="Application web progressive pour scanner des QR codes et prendre des photos">
    <meta property="og:image" content="./icons/icon-512.png">
    <meta property="og:url" content="https://votre-username.github.io/pwa-camera-qr-scanner/">
    <meta property="og:type" content="website">
    
    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="PWA Camera & QR Scanner">
    <meta name="twitter:description" content="Scanner QR codes et appareil photo en PWA">
    <meta name="twitter:image" content="./icons/icon-512.png">
    <!-- External CSS -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± Camera PWA Test</h1>
            <p>Test des fonctionnalit√©s de cam√©ra dans une Progressive Web App</p>
        </div>

        <div id="status" class="status info">
            üîç Initialisation...
        </div>

        <div class="camera-container">
            <video id="videoElement" autoplay muted playsinline></video>
            <div id="cameraPlaceholder" class="camera-placeholder">
                <svg fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <p>Cam√©ra non activ√©e</p>
            </div>
        </div>

        <div class="controls">
            <button id="startBtn">üé• D√©marrer Cam√©ra</button>
            <button id="captureBtn" class="capture-btn" disabled>üì∏ Capturer</button>
            <button id="switchBtn" disabled>üîÑ Basculer</button>
            <button id="stopBtn" disabled>‚èπÔ∏è Arr√™ter</button>
        </div>

        <div class="info-panel">
            <h3>üìã Informations Techniques</h3>
            <div class="info-item">
                <span>Support getUserMedia:</span>
                <span id="supportInfo">-</span>
            </div>
            <div class="info-item">
                <span>Cam√©ras disponibles:</span>
                <span id="camerasInfo">-</span>
            </div>
            <div class="info-item">
                <span>R√©solution actuelle:</span>
                <span id="resolutionInfo">-</span>
            </div>
            <div class="info-item">
                <span>Mode cam√©ra:</span>
                <span id="facingModeInfo">-</span>
            </div>
            <div class="info-item">
                <span>Photos prises:</span>
                <span id="photosCount">0</span>
            </div>
        </div>

        <div class="gallery">
            <h3>üì∑ Galerie Photos</h3>
            <div id="galleryGrid" class="gallery-grid"></div>
        </div>
    </div>

    <script>
        class CameraPWA {
            constructor() {
                this.stream = null;
                this.videoElement = document.getElementById('videoElement');
                this.currentFacingMode = 'user';
                this.photos = [];
                this.availableCameras = [];
                
                this.initElements();
                this.checkSupport();
                this.detectCameras();
            }

            initElements() {
                this.statusElement = document.getElementById('status');
                this.startBtn = document.getElementById('startBtn');
                this.captureBtn = document.getElementById('captureBtn');
                this.switchBtn = document.getElementById('switchBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.placeholder = document.getElementById('cameraPlaceholder');
                this.galleryGrid = document.getElementById('galleryGrid');

                // Event listeners
                this.startBtn.addEventListener('click', () => this.startCamera());
                this.captureBtn.addEventListener('click', () => this.capturePhoto());
                this.switchBtn.addEventListener('click', () => this.switchCamera());
                this.stopBtn.addEventListener('click', () => this.stopCamera());
            }

            checkSupport() {
                const hasSupport = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
                document.getElementById('supportInfo').textContent = hasSupport ? '‚úÖ Support√©' : '‚ùå Non support√©';
                
                if (!hasSupport) {
                    this.updateStatus('‚ùå getUserMedia non support√© par ce navigateur', 'error');
                    this.startBtn.disabled = true;
                } else {
                    this.updateStatus('‚úÖ Navigateur compatible d√©tect√©', 'success');
                }
            }

            async detectCameras() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    this.availableCameras = devices.filter(device => device.kind === 'videoinput');
                    
                    const count = this.availableCameras.length;
                    document.getElementById('camerasInfo').textContent = `${count} d√©tect√©e(s)`;
                    
                    if (count > 1) {
                        this.switchBtn.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Erreur d√©tection cam√©ras:', error);
                    document.getElementById('camerasInfo').textContent = 'Erreur de d√©tection';
                }
            }

            async startCamera() {
                try {
                    this.updateStatus('üîÑ Demande d\'acc√®s √† la cam√©ra...', 'info');

                    const constraints = {
                        video: {
                            facingMode: this.currentFacingMode,
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    };

                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    this.videoElement.srcObject = this.stream;
                    this.videoElement.style.display = 'block';
                    this.placeholder.style.display = 'none';

                    this.videoElement.onloadedmetadata = () => {
                        this.updateVideoInfo();
                        this.updateStatus('‚úÖ Cam√©ra activ√©e avec succ√®s', 'success');
                        this.updateButtons(true);
                    };

                } catch (error) {
                    console.error('Erreur d\'acc√®s √† la cam√©ra:', error);
                    let message = '‚ùå Erreur d\'acc√®s √† la cam√©ra: ';
                    
                    switch(error.name) {
                        case 'NotAllowedError':
                            message += 'Permission refus√©e';
                            break;
                        case 'NotFoundError':
                            message += 'Aucune cam√©ra trouv√©e';
                            break;
                        case 'NotReadableError':
                            message += 'Cam√©ra d√©j√† utilis√©e';
                            break;
                        default:
                            message += error.message;
                    }
                    
                    this.updateStatus(message, 'error');
                }
            }

            capturePhoto() {
                if (!this.stream) return;

                // Effet flash
                this.createFlashEffect();

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                
                canvas.width = this.videoElement.videoWidth;
                canvas.height = this.videoElement.videoHeight;
                
                context.drawImage(this.videoElement, 0, 0);
                
                const imageData = canvas.toDataURL('image/png');
                const timestamp = new Date().toLocaleString('fr-FR');
                
                const photo = {
                    id: Date.now(),
                    data: imageData,
                    timestamp: timestamp,
                    resolution: `${canvas.width}x${canvas.height}`
                };
                
                this.photos.push(photo);
                this.updatePhotosCount();
                this.renderGallery();
                
                this.updateStatus(`üì∏ Photo captur√©e (${canvas.width}x${canvas.height})`, 'success');
            }

            createFlashEffect() {
                const flash = document.createElement('div');
                flash.className = 'flash-effect';
                document.body.appendChild(flash);
                
                setTimeout(() => {
                    document.body.removeChild(flash);
                }, 300);
            }

            async switchCamera() {
                if (this.availableCameras.length < 2) return;
                
                this.currentFacingMode = this.currentFacingMode === 'user' ? 'environment' : 'user';
                
                if (this.stream) {
                    this.stopCamera();
                    setTimeout(() => this.startCamera(), 100);
                }
            }

            stopCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                
                this.videoElement.srcObject = null;
                this.videoElement.style.display = 'none';
                this.placeholder.style.display = 'block';
                
                this.updateStatus('‚èπÔ∏è Cam√©ra arr√™t√©e', 'info');
                this.updateButtons(false);
                this.clearVideoInfo();
            }

            updateVideoInfo() {
                const width = this.videoElement.videoWidth;
                const height = this.videoElement.videoHeight;
                
                document.getElementById('resolutionInfo').textContent = `${width}x${height}`;
                document.getElementById('facingModeInfo').textContent = 
                    this.currentFacingMode === 'user' ? 'ü§≥ Avant' : 'üì∑ Arri√®re';
            }

            clearVideoInfo() {
                document.getElementById('resolutionInfo').textContent = '-';
                document.getElementById('facingModeInfo').textContent = '-';
            }

            updateButtons(cameraActive) {
                this.startBtn.disabled = cameraActive;
                this.captureBtn.disabled = !cameraActive;
                this.switchBtn.disabled = !cameraActive || this.availableCameras.length < 2;
                this.stopBtn.disabled = !cameraActive;
            }

            updateStatus(message, type) {
                this.statusElement.textContent = message;
                this.statusElement.className = `status ${type}`;
            }

            updatePhotosCount() {
                document.getElementById('photosCount').textContent = this.photos.length;
            }

            renderGallery() {
                this.galleryGrid.innerHTML = '';
                
                this.photos.forEach(photo => {
                    const photoDiv = document.createElement('div');
                    photoDiv.className = 'photo-item';
                    
                    photoDiv.innerHTML = `
                        <img src="${photo.data}" alt="Photo ${photo.timestamp}">
                        <button class="delete-btn" onclick="camera.deletePhoto(${photo.id})">üóëÔ∏è</button>
                        <div style="padding: 10px; font-size: 12px; background: rgba(0,0,0,0.8);">
                            <div>${photo.timestamp}</div>
                            <div>${photo.resolution}</div>
                        </div>
                    `;
                    
                    this.galleryGrid.appendChild(photoDiv);
                });
            }

            deletePhoto(photoId) {
                this.photos = this.photos.filter(photo => photo.id !== photoId);
                this.updatePhotosCount();
                this.renderGallery();
                this.updateStatus('üóëÔ∏è Photo supprim√©e', 'info');
            }

            // Installation PWA
            showInstallPrompt() {
                if (this.deferredPrompt) {
                    this.deferredPrompt.prompt();
                    this.deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            this.updateStatus('‚úÖ PWA install√©e!', 'success');
                        }
                        this.deferredPrompt = null;
                    });
                }
            }
        }

        // Initialisation
        let camera;

        document.addEventListener('DOMContentLoaded', () => {
            camera = new CameraPWA();
        });

        // Service Worker pour PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'camera-pwa-v1';
                    const urlsToCache = ['/'];
                    
                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => response || fetch(event.request))
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        console.log('SW registered:', registration);
                    })
                    .catch(error => {
                        console.log('SW registration failed:', error);
                    });
            });
        }

        // Gestion installation PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Cr√©er bouton d'installation
            const installBtn = document.createElement('button');
            installBtn.textContent = 'üì± Installer PWA';
            installBtn.onclick = () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA install√©e');
                        installBtn.remove();
                    }
                    deferredPrompt = null;
                });
            };
            
            document.querySelector('.controls').appendChild(installBtn);
        });
    </script>
</body>
</html>