<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Camera PWA Test</title>
    
    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2563eb">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Camera Test">
    
    <!-- Manifest -->
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ2FtZXJhIFBXQSBUZXN0Iiwic2hvcnRfbmFtZSI6IkNhbVRlc3QiLCJzdGFydF91cmwiOiIvIiwiZGlzcGxheSI6InN0YW5kYWxvbmUiLCJiYWNrZ3JvdW5kX2NvbG9yIjoiI2ZmZmZmZiIsInRoZW1lX2NvbG9yIjoiIzI1NjNlYiIsImljb25zIjpbeyJzcmMiOiJkYXRhOmltYWdlL3N2Zyt4bWw7YmFzZTY0LFBITjJaeUI0Yld4dWN6MGlhSFIwY0RvdkwzZDNkeTUzTXk1dmNtY3ZNakF3TUM5emRtY2lJSGRwWkhSb1BTSXlORFFpSUdobGFXZG9kRDBpTWpRMElqNDhZMmx5WTJ4bElHTjRQU0l4TWpJaUlHTjVQU0l4TWpJaUlISStJalV5SW1acGJHdzlJaU15TlRZemFqSWlMejQ4TDNOMlp6ND0iLCJzaXplcyI6IjI0NHgyNDQiLCJ0eXBlIjoiaW1hZ2Uvc3ZnK3htbCJ9XX0=">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: white;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }

        .header {
            margin-bottom: 30px;
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .status {
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .status.info {
            background: rgba(59, 130, 246, 0.8);
            border: 1px solid rgba(59, 130, 246, 0.5);
        }

        .status.success {
            background: rgba(16, 185, 129, 0.8);
            border: 1px solid rgba(16, 185, 129, 0.5);
        }

        .status.error {
            background: rgba(239, 68, 68, 0.8);
            border: 1px solid rgba(239, 68, 68, 0.5);
        }

        .camera-container {
            position: relative;
            margin: 30px 0;
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
            background: rgba(0,0,0,0.8);
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #videoElement {
            width: 100%;
            height: auto;
            max-height: 500px;
            object-fit: cover;
            display: none;
        }

        .camera-placeholder {
            padding: 50px;
            color: rgba(255,255,255,0.7);
        }

        .camera-placeholder svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
        }

        button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            min-width: 140px;
        }

        button:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .capture-btn {
            background: rgba(16, 185, 129, 0.8);
            border-color: rgba(16, 185, 129, 0.5);
        }

        .capture-btn:hover:not(:disabled) {
            background: rgba(16, 185, 129, 1);
        }

        .gallery {
            margin-top: 40px;
        }

        .gallery h3 {
            margin-bottom: 20px;
            font-size: 1.5rem;
        }

        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .photo-item {
            position: relative;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            transition: transform 0.3s ease;
        }

        .photo-item:hover {
            transform: scale(1.05);
        }

        .photo-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }

        .photo-item .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 30px;
            height: 30px;
            min-width: unset;
            padding: 5px;
            background: rgba(239, 68, 68, 0.9);
            border: none;
            border-radius: 50%;
            font-size: 12px;
        }

        .info-panel {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 30px 0;
            backdrop-filter: blur(10px);
            text-align: left;
        }

        .info-panel h3 {
            margin-bottom: 15px;
            color: #fbbf24;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .info-item:last-child {
            border-bottom: none;
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .controls {
                flex-direction: column;
                align-items: center;
            }
            
            button {
                width: 100%;
                max-width: 300px;
            }
        }

        .flash-effect {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            opacity: 0;
            pointer-events: none;
            z-index: 9999;
            animation: flash 0.3s ease-out;
        }

        @keyframes flash {
            0% { opacity: 0; }
            50% { opacity: 0.8; }
            100% { opacity: 0; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± Camera PWA Test</h1>
            <p>Test des fonctionnalit√©s de cam√©ra dans une Progressive Web App</p>
        </div>

        <div id="status" class="status info">
            üîç Initialisation...
        </div>

        <div class="camera-container">
            <video id="videoElement" autoplay muted playsinline></video>
            <div id="cameraPlaceholder" class="camera-placeholder">
                <svg fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
                </svg>
                <p>Cam√©ra non activ√©e</p>
            </div>
        </div>

        <div class="controls">
            <button id="startBtn">üé• D√©marrer Cam√©ra</button>
            <button id="captureBtn" class="capture-btn" disabled>üì∏ Capturer</button>
            <button id="switchBtn" disabled>üîÑ Basculer</button>
            <button id="stopBtn" disabled>‚èπÔ∏è Arr√™ter</button>
        </div>

        <div class="info-panel">
            <h3>üìã Informations Techniques</h3>
            <div class="info-item">
                <span>Support getUserMedia:</span>
                <span id="supportInfo">-</span>
            </div>
            <div class="info-item">
                <span>Cam√©ras disponibles:</span>
                <span id="camerasInfo">-</span>
            </div>
            <div class="info-item">
                <span>R√©solution actuelle:</span>
                <span id="resolutionInfo">-</span>
            </div>
            <div class="info-item">
                <span>Mode cam√©ra:</span>
                <span id="facingModeInfo">-</span>
            </div>
            <div class="info-item">
                <span>Photos prises:</span>
                <span id="photosCount">0</span>
            </div>
        </div>

        <div class="gallery">
            <h3>üì∑ Galerie Photos</h3>
            <div id="galleryGrid" class="gallery-grid"></div>
        </div>
    </div>

    <script>
        class CameraPWA {
            constructor() {
                this.stream = null;
                this.videoElement = document.getElementById('videoElement');
                this.currentFacingMode = 'user';
                this.photos = [];
                this.availableCameras = [];
                
                this.initElements();
                this.checkSupport();
                this.detectCameras();
            }

            initElements() {
                this.statusElement = document.getElementById('status');
                this.startBtn = document.getElementById('startBtn');
                this.captureBtn = document.getElementById('captureBtn');
                this.switchBtn = document.getElementById('switchBtn');
                this.stopBtn = document.getElementById('stopBtn');
                this.placeholder = document.getElementById('cameraPlaceholder');
                this.galleryGrid = document.getElementById('galleryGrid');

                // Event listeners
                this.startBtn.addEventListener('click', () => this.startCamera());
                this.captureBtn.addEventListener('click', () => this.capturePhoto());
                this.switchBtn.addEventListener('click', () => this.switchCamera());
                this.stopBtn.addEventListener('click', () => this.stopCamera());
            }

            checkSupport() {
                const hasSupport = !!(navigator.mediaDevices && navigator.mediaDevices.getUserMedia);
                document.getElementById('supportInfo').textContent = hasSupport ? '‚úÖ Support√©' : '‚ùå Non support√©';
                
                if (!hasSupport) {
                    this.updateStatus('‚ùå getUserMedia non support√© par ce navigateur', 'error');
                    this.startBtn.disabled = true;
                } else {
                    this.updateStatus('‚úÖ Navigateur compatible d√©tect√©', 'success');
                }
            }

            async detectCameras() {
                try {
                    const devices = await navigator.mediaDevices.enumerateDevices();
                    this.availableCameras = devices.filter(device => device.kind === 'videoinput');
                    
                    const count = this.availableCameras.length;
                    document.getElementById('camerasInfo').textContent = `${count} d√©tect√©e(s)`;
                    
                    if (count > 1) {
                        this.switchBtn.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Erreur d√©tection cam√©ras:', error);
                    document.getElementById('camerasInfo').textContent = 'Erreur de d√©tection';
                }
            }

            async startCamera() {
                try {
                    this.updateStatus('üîÑ Demande d\'acc√®s √† la cam√©ra...', 'info');

                    const constraints = {
                        video: {
                            facingMode: this.currentFacingMode,
                            width: { ideal: 1280 },
                            height: { ideal: 720 }
                        },
                        audio: false
                    };

                    this.stream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    this.videoElement.srcObject = this.stream;
                    this.videoElement.style.display = 'block';
                    this.placeholder.style.display = 'none';

                    this.videoElement.onloadedmetadata = () => {
                        this.updateVideoInfo();
                        this.updateStatus('‚úÖ Cam√©ra activ√©e avec succ√®s', 'success');
                        this.updateButtons(true);
                    };

                } catch (error) {
                    console.error('Erreur d\'acc√®s √† la cam√©ra:', error);
                    let message = '‚ùå Erreur d\'acc√®s √† la cam√©ra: ';
                    
                    switch(error.name) {
                        case 'NotAllowedError':
                            message += 'Permission refus√©e';
                            break;
                        case 'NotFoundError':
                            message += 'Aucune cam√©ra trouv√©e';
                            break;
                        case 'NotReadableError':
                            message += 'Cam√©ra d√©j√† utilis√©e';
                            break;
                        default:
                            message += error.message;
                    }
                    
                    this.updateStatus(message, 'error');
                }
            }

            capturePhoto() {
                if (!this.stream) return;

                // Effet flash
                this.createFlashEffect();

                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                
                canvas.width = this.videoElement.videoWidth;
                canvas.height = this.videoElement.videoHeight;
                
                context.drawImage(this.videoElement, 0, 0);
                
                const imageData = canvas.toDataURL('image/png');
                const timestamp = new Date().toLocaleString('fr-FR');
                
                const photo = {
                    id: Date.now(),
                    data: imageData,
                    timestamp: timestamp,
                    resolution: `${canvas.width}x${canvas.height}`
                };
                
                this.photos.push(photo);
                this.updatePhotosCount();
                this.renderGallery();
                
                this.updateStatus(`üì∏ Photo captur√©e (${canvas.width}x${canvas.height})`, 'success');
            }

            createFlashEffect() {
                const flash = document.createElement('div');
                flash.className = 'flash-effect';
                document.body.appendChild(flash);
                
                setTimeout(() => {
                    document.body.removeChild(flash);
                }, 300);
            }

            async switchCamera() {
                if (this.availableCameras.length < 2) return;
                
                this.currentFacingMode = this.currentFacingMode === 'user' ? 'environment' : 'user';
                
                if (this.stream) {
                    this.stopCamera();
                    setTimeout(() => this.startCamera(), 100);
                }
            }

            stopCamera() {
                if (this.stream) {
                    this.stream.getTracks().forEach(track => track.stop());
                    this.stream = null;
                }
                
                this.videoElement.srcObject = null;
                this.videoElement.style.display = 'none';
                this.placeholder.style.display = 'block';
                
                this.updateStatus('‚èπÔ∏è Cam√©ra arr√™t√©e', 'info');
                this.updateButtons(false);
                this.clearVideoInfo();
            }

            updateVideoInfo() {
                const width = this.videoElement.videoWidth;
                const height = this.videoElement.videoHeight;
                
                document.getElementById('resolutionInfo').textContent = `${width}x${height}`;
                document.getElementById('facingModeInfo').textContent = 
                    this.currentFacingMode === 'user' ? 'ü§≥ Avant' : 'üì∑ Arri√®re';
            }

            clearVideoInfo() {
                document.getElementById('resolutionInfo').textContent = '-';
                document.getElementById('facingModeInfo').textContent = '-';
            }

            updateButtons(cameraActive) {
                this.startBtn.disabled = cameraActive;
                this.captureBtn.disabled = !cameraActive;
                this.switchBtn.disabled = !cameraActive || this.availableCameras.length < 2;
                this.stopBtn.disabled = !cameraActive;
            }

            updateStatus(message, type) {
                this.statusElement.textContent = message;
                this.statusElement.className = `status ${type}`;
            }

            updatePhotosCount() {
                document.getElementById('photosCount').textContent = this.photos.length;
            }

            renderGallery() {
                this.galleryGrid.innerHTML = '';
                
                this.photos.forEach(photo => {
                    const photoDiv = document.createElement('div');
                    photoDiv.className = 'photo-item';
                    
                    photoDiv.innerHTML = `
                        <img src="${photo.data}" alt="Photo ${photo.timestamp}">
                        <button class="delete-btn" onclick="camera.deletePhoto(${photo.id})">üóëÔ∏è</button>
                        <div style="padding: 10px; font-size: 12px; background: rgba(0,0,0,0.8);">
                            <div>${photo.timestamp}</div>
                            <div>${photo.resolution}</div>
                        </div>
                    `;
                    
                    this.galleryGrid.appendChild(photoDiv);
                });
            }

            deletePhoto(photoId) {
                this.photos = this.photos.filter(photo => photo.id !== photoId);
                this.updatePhotosCount();
                this.renderGallery();
                this.updateStatus('üóëÔ∏è Photo supprim√©e', 'info');
            }

            // Installation PWA
            showInstallPrompt() {
                if (this.deferredPrompt) {
                    this.deferredPrompt.prompt();
                    this.deferredPrompt.userChoice.then((choiceResult) => {
                        if (choiceResult.outcome === 'accepted') {
                            this.updateStatus('‚úÖ PWA install√©e!', 'success');
                        }
                        this.deferredPrompt = null;
                    });
                }
            }
        }

        // Initialisation
        let camera;

        document.addEventListener('DOMContentLoaded', () => {
            camera = new CameraPWA();
        });

        // Service Worker pour PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const swCode = `
                    const CACHE_NAME = 'camera-pwa-v1';
                    const urlsToCache = ['/'];
                    
                    self.addEventListener('install', event => {
                        event.waitUntil(
                            caches.open(CACHE_NAME)
                                .then(cache => cache.addAll(urlsToCache))
                        );
                    });
                    
                    self.addEventListener('fetch', event => {
                        event.respondWith(
                            caches.match(event.request)
                                .then(response => response || fetch(event.request))
                        );
                    });
                `;
                
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                
                navigator.serviceWorker.register(swUrl)
                    .then(registration => {
                        console.log('SW registered:', registration);
                    })
                    .catch(error => {
                        console.log('SW registration failed:', error);
                    });
            });
        }

        // Gestion installation PWA
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            
            // Cr√©er bouton d'installation
            const installBtn = document.createElement('button');
            installBtn.textContent = 'üì± Installer PWA';
            installBtn.onclick = () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWA install√©e');
                        installBtn.remove();
                    }
                    deferredPrompt = null;
                });
            };
            
            document.querySelector('.controls').appendChild(installBtn);
        });
    </script>
</body>
</html>